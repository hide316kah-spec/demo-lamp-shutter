<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ©ãƒ³ãƒ—ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ ãƒ‡ãƒ¢</title>

<style>
  body{margin:0;background:#000;color:#fff;font-family:system-ui;overflow:hidden}
  video{width:100vw;height:100vh;object-fit:cover}

  #roi{
    position:fixed;top:50%;left:50%;
    width:75px;height:75px;
    transform:translate(-50%,-50%);
    border:4px solid #00ffff;border-radius:50%;
    pointer-events:none;z-index:3;
  }

  #result{
    position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
    font-size:30px;font-weight:900;text-align:center;line-height:1.25;
    text-shadow:0 0 16px rgba(0,0,0,.9);
    white-space:normal; /* â† æ”¹è¡Œã•ã›ãªã„ */
    z-index:3;
  }
  .ok{color:#00ff66}
  .ng{color:#ff3333}

  #fx{position:fixed;inset:0;pointer-events:none;z-index:2}
  .particle{position:absolute;font-size:18px;opacity:.85;animation:float linear infinite}
  @keyframes float{from{transform:translateY(0)}to{transform:translateY(-120vh)}}
</style>
</head>

<body>
<video id="video" autoplay playsinline></video>
<div id="fx"></div>
<div id="roi"></div>
<div id="result">å††ã‚’â—ã«ã‚ã‚ã›ã¦</div>
<canvas id="canvas" width="80" height="80" style="display:none"></canvas>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});
const result=document.getElementById("result");
const fx=document.getElementById("fx");

const ROI_D=80;           // â† å°‘ã—å¤§ããï¼ˆæ‹¾ã„ã‚„ã™ãï¼‰
const LOCK_TIME=700;      // â† æ—©ã‚ã«æˆ»ã‚‹ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ„Ÿï¼‰
let lockUntil=0;
let state="none";
let fxTimer=null;

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false})
.then(s=>video.srcObject=s);

// ===== FX =====
function clearFX(){
  fx.innerHTML="";
  if(fxTimer){clearInterval(fxTimer);fxTimer=null;}
}
function startFX(type){
  clearFX();
  const emoji=(type==="angel")?"ğŸ˜ˆ":"âœ¨";
  fxTimer=setInterval(()=>{
    if(fx.children.length>=18) return;
    const p=document.createElement("div");
    p.className="particle";
    p.textContent=emoji;
    p.style.left=(Math.random()*100)+"vw";
    p.style.bottom="-10vh";
    p.style.animationDuration=(6+Math.random()*6)+"s";
    fx.appendChild(p);
    setTimeout(()=>p.remove(),12000);
  },350);
}

// ===== çŠ¶æ…‹è¡¨ç¤º =====
function setState(newState){
  if(newState===state) return;
  state=newState;
  lockUntil=Date.now()+LOCK_TIME;

  if(newState==="angel"){
    result.className="ng";
    result.textContent="NGï¼ å®Ÿã¯å •å¤©ä½¿ã€€æ°—ã‚’ã¤ã‘ã¦";   // â† 2è¡Œã«ã—ãªã„
    startFX("angel");
  }else if(newState==="nio"){
    result.className="ok";
    result.textContent="OKï¼ é‡‘å‰›åŠ›å£«ã€€è¦‹ãŸç›®ã¯é¬¼ã§ã‚‚å®ˆã‚Šç¥"; // â† 2è¡Œã«ã—ãªã„
    startFX("nio");
  }else{
    result.className="";
    result.textContent="å††ã‚’â—ã«ã‚ã‚ã›ã¦";              // â† 1è¡Œå›ºå®š
    clearFX();
  }
}

// ===== åˆ¤å®š =====
function check(){
  if(!video.videoWidth) return;
  if(Date.now()<lockUntil) return;

  const sx=(video.videoWidth-ROI_D)/2;
  const sy=(video.videoHeight-ROI_D)/2;

  ctx.drawImage(video,sx,sy,ROI_D,ROI_D,0,0,ROI_D,ROI_D);
  const d=ctx.getImageData(0,0,ROI_D,ROI_D).data;

  let r=0,g=0,b=0,n=d.length/4;
  for(let i=0;i<d.length;i+=4){ r+=d[i]; g+=d[i+1]; b+=d[i+2]; }
  r/=n; g/=n; b/=n;

  const lum=(r+g+b)/3;
  if(lum<20){ setState("none"); return; } // æš—ã™ãã¯ç„¡è¦–

  /*
    æ¿€ã‚¢ãƒåˆ¤å®šï¼ˆç™½ãƒãƒ©ãƒ³ã‚¹å´©ã‚Œã‚’å¸åã™ã‚‹ï¼‰
    - ã‚·ã‚¢ãƒ³ï¼šGã¨BãŒã€Œãã“ãã“é«˜ã„ã€ã‹ã¤ RãŒã€Œãã“ãã“ä½ã„ã€
    - ãƒã‚¼ãƒ³ã‚¿ï¼šRã¨BãŒã€Œãã“ãã“é«˜ã„ã€ã‹ã¤ GãŒã€Œãã“ãã“ä½ã„ã€
    ã•ã‚‰ã« â€œå„ªä½å·®â€ ã§ã‚‚æ‹¾ã†ï¼ˆæ··è‰²ã«å¼·ã„ï¼‰
  */

  // å„ªä½å·®ï¼ˆã©ã‚Œã ã‘ä»–ã‚ˆã‚Šå¼·ã„ã‹ï¼‰
  const cyanAdv = (g + b) - (2 * r);
  const magAdv  = (r + b) - (2 * g);

  // ã‚·ã‚¢ãƒ³ï¼ˆå¤©ä½¿ï¼‰è¶…ã‚†ã‚‹
  const isAngel =
    (
      g > 110 && b > 110 && r < 170
    ) ||
    (
      cyanAdv > 120 && b > 90 && g > 90
    );

  // ãƒã‚¼ãƒ³ã‚¿ï¼ˆé‡‘å‰›åŠ›å£«ï¼‰è¶…ã‚†ã‚‹
  const isNio =
    (
      r > 110 && b > 110 && g < 170
    ) ||
    (
      magAdv > 120 && b > 90 && r > 90
    );

  // ã©ã£ã¡ã‚‚æˆç«‹ã—ã†ã‚‹ã¨ãã¯ã€Œã‚ˆã‚Šå„ªä½ãŒå¤§ãã„æ–¹ã€
  if(isAngel && isNio){
    if(cyanAdv >= magAdv) setState("angel");
    else setState("nio");
    return;
  }

  if(isAngel){ setState("angel"); return; }
  if(isNio){ setState("nio"); return; }

  setState("none");
}

setInterval(check, 150); // â† åå¿œã‚’é€Ÿã
</script>
</body>
</html>
