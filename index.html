<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ランプシャッター デモ</title>

<style>
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    overflow: hidden;
  }

  video {
    width: 100vw;
    height: 100vh;
    object-fit: cover;
  }

  /* ROI：中央・大きめ */
  #roi {
    position: fixed;
    top: 50%;
    left: 50%;
    width: 260px;
    height: 180px;
    transform: translate(-50%, -50%);
    border: 4px solid yellow;
    box-sizing: border-box;
    pointer-events: none;
  }

  #result {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 28px;
    font-weight: 900;
    text-align: center;
    line-height: 1.35;
    text-shadow: 0 0 14px rgba(0,0,0,0.9);
    padding: 0 12px;
    white-space: pre-line;
  }

  /* 任意：デバッグ（小さく出す） */
  #dbg {
    position: fixed;
    top: 10px;
    left: 10px;
    font-size: 14px;
    opacity: 0.7;
    white-space: pre-line;
  }
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<div id="roi"></div>
<div id="result">かざしてみて</div>
<div id="dbg"></div>

<canvas id="canvas" width="260" height="180" style="display:none;"></canvas>

<script>
const video  = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx    = canvas.getContext("2d", { willReadFrequently: true });
const result = document.getElementById("result");
const dbg    = document.getElementById("dbg");

const ROI_W = 260;
const ROI_H = 180;

// 判定を安定させるため：同じ結果を少し保持
let lastLabel = "none";
let holdUntil = 0;

// カメラ起動
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" },
  audio: false
}).then(stream => {
  video.srcObject = stream;
}).catch(err => {
  result.textContent = "カメラが使えません";
  console.error(err);
});

function setLabel(label, color, text) {
  const now = Date.now();
  if (label !== lastLabel) {
    lastLabel = label;
    holdUntil = now + 900; // 0.9秒固定（チラつき防止）
    result.textContent = text;
    result.style.color = color;
  } else {
    // 同じラベルなら保持時間更新しない
  }
}

function checkColor() {
  if (video.videoWidth === 0) return;

  const sx = (video.videoWidth  - ROI_W) / 2;
  const sy = (video.videoHeight - ROI_H) / 2;

  ctx.drawImage(video, sx, sy, ROI_W, ROI_H, 0, 0, ROI_W, ROI_H);
  const data = ctx.getImageData(0, 0, ROI_W, ROI_H).data;

  let r = 0, g = 0, b = 0;
  const pixels = data.length / 4;

  for (let i = 0; i < data.length; i += 4) {
    r += data[i];
    g += data[i + 1];
    b += data[i + 2];
  }

  r /= pixels; g /= pixels; b /= pixels;

  // ---- 判定指標 ----
  // 赤らしさ：Rが強く、G/Bより優位
  const redScore = r - (g + b) / 2;

  // 黄らしさ：RとGが両方強く、Bが弱い
  const yellowScore = (r + g) / 2 - b;

  // 明るさ（暗所の誤判定を避ける）
  const lum = (r + g + b) / 3;

  // デバッグ表示（邪魔なら消せ）
  dbg.textContent = `R:${r.toFixed(0)} G:${g.toFixed(0)} B:${b.toFixed(0)}
redScore:${redScore.toFixed(1)}  yellowScore:${yellowScore.toFixed(1)}  lum:${lum.toFixed(0)}`;

  const now = Date.now();

  // 既にラベルを表示中で保持期間内なら、判定を固定してチラつきを防ぐ
  if (now < holdUntil) return;

  // 暗すぎる時は何も言わない
  if (lum < 35) {
    setLabel("none", "white", "かざしてみて");
    return;
  }

  // ---- 閾値（デモ用に強め）----
  // 実物の色マーカーを「ベタ塗り」で用意する前提
  const RED_TH = 35;     // 赤優位の強さ
  const YEL_TH = 55;     // 黄の強さ
  const DOM_TH = 1.15;   // 優位比率

  const isRedDominant = (r > g * DOM_TH) && (r > b * (DOM_TH + 0.05)) && (redScore > RED_TH);
  const isYellowDominant = (yellowScore > YEL_TH) && (r > 80) && (g > 80) && (b < 110);

  // 優先順位：黄→天使、赤→金剛力士
  // （黄は環境で白に寄る場合があるので、条件を厳しめにして誤爆を抑える）
  if (isYellowDominant && !isRedDominant) {
    setLabel("angel", "yellow", "NG！実は堕天使\n気をつけて");
    return;
  }

  if (isRedDominant) {
    setLabel("nio", "red", "OK！見た目は鬼でも\n金剛力士");
    return;
  }

  setLabel("none", "white", "かざしてみて");
}

setInterval(checkColor, 200);
</script>

</body>
</html>
