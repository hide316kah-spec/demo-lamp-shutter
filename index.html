<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ランプシャッター デモ</title>

<style>
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    overflow: hidden;
  }

  video {
    width: 100vw;
    height: 100vh;
    object-fit: cover;
  }

  /* ROI：中央・大きめ */
  #roi {
    position: fixed;
    top: 50%;
    left: 50%;
    width: 260px;
    height: 180px;
    transform: translate(-50%, -50%);
    border: 4px solid yellow;
    box-sizing: border-box;
    pointer-events: none;
  }

  #result {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 28px;
    font-weight: 900;
    text-align: center;
    line-height: 1.35;
    text-shadow: 0 0 14px rgba(0,0,0,0.9);
    padding: 0 12px;
    white-space: pre-line;
  }
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<div id="roi"></div>
<div id="result">かざしてみて</div>

<canvas id="canvas" width="260" height="180" style="display:none;"></canvas>

<script>
const video  = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx    = canvas.getContext("2d", { willReadFrequently: true });
const result = document.getElementById("result");

const ROI_W = 260;
const ROI_H = 180;

// 表示固定（チラつき防止）
let lastLabel = "none";
let holdUntil = 0;

// カメラ起動
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" },
  audio: false
}).then(stream => {
  video.srcObject = stream;
}).catch(err => {
  result.textContent = "カメラが使えません";
  console.error(err);
});

function setLabel(label, color, text) {
  const now = Date.now();
  if (label !== lastLabel) {
    lastLabel = label;
    holdUntil = now + 900; // 0.9秒固定
    result.textContent = text;
    result.style.color = color;
  }
}

function checkColor() {
  if (video.videoWidth === 0) return;

  // 中央ROI切り出し
  const sx = (video.videoWidth  - ROI_W) / 2;
  const sy = (video.videoHeight - ROI_H) / 2;

  ctx.drawImage(video, sx, sy, ROI_W, ROI_H, 0, 0, ROI_W, ROI_H);
  const data = ctx.getImageData(0, 0, ROI_W, ROI_H).data;

  let r = 0, g = 0, b = 0;
  const pixels = data.length / 4;

  for (let i = 0; i < data.length; i += 4) {
    r += data[i];
    g += data[i + 1];
    b += data[i + 2];
  }

  r /= pixels;
  g /= pixels;
  b /= pixels;

  const lum = (r + g + b) / 3;
  const now = Date.now();

  // 表示保持中は再判定しない
  if (now < holdUntil) return;

  // 暗すぎる場合は黙る（事故防止）
  if (lum < 40) {
    setLabel("none", "white", "かざしてみて");
    return;
  }

  /* =========================
     判定ロジック（重要）
     ① 黄色を最優先
     ② 次に赤
     ③ それ以外は無表示
     ========================= */

  // 黄色（天使）判定：RとGが両方高く、差が小さく、Bが低い
  const isYellow =
    r > 160 &&
    g > 160 &&
    Math.abs(r - g) < 25 &&
    b < 110;

  // 赤（金剛力士）判定：Rが圧倒的に優位
  const isRed =
    r > 160 &&
    r > g * 1.35 &&
    r > b * 1.4;

  // 優先順位厳守
  if (isYellow) {
    setLabel(
      "angel",
      "yellow",
      "NG！実は堕天使\n気をつけて"
    );
    return;
  }

  if (isRed) {
    setLabel(
      "nio",
      "red",
      "OK！見た目は鬼でも\n金剛力士"
    );
    return;
  }

  setLabel("none", "white", "かざしてみて");
}

// 200ms周期
setInterval(checkColor, 200);
</script>

</body>
</html>
