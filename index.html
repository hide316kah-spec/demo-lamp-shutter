<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ©ãƒ³ãƒ—ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ ãƒ‡ãƒ¢</title>

<style>
  body{
    margin:0;background:#000;color:#fff;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
    overflow:hidden;
  }
  video{width:100vw;height:100vh;object-fit:cover}

  /* ROIï¼šä¸­å¤®ãƒ»ä¸¸ */
  #roi{
    position:fixed;top:50%;left:50%;
    width:75px;height:75px;
    transform:translate(-50%,-50%);
    border:4px solid #00ffff;
    border-radius:50%;
    pointer-events:none;z-index:3;
  }

  #result{
    position:fixed;bottom:28px;left:50%;
    transform:translateX(-50%);
    font-size:30px;font-weight:900;text-align:center;
    line-height:1.2;
    text-shadow:0 0 16px rgba(0,0,0,.9);
    white-space:pre-line; /* â† æ„å›³ã—ãŸ2æ®µã®ã¿ */
    z-index:3;
  }
  .ok{color:#00ff66}
  .ng{color:#ff3333}

  /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
  #fx{position:fixed;inset:0;pointer-events:none;z-index:2;overflow:hidden}
  .particle{
    position:absolute;
    font-size:18px;
    opacity:.85;
    animation:fall linear infinite;
  }
  /* ä¸Š â†’ ä¸‹ */
  @keyframes fall{
    from{transform:translateY(-20vh)}
    to{transform:translateY(120vh)}
  }
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<div id="fx"></div>
<div id="roi"></div>
<div id="result">å††ã‚’â—ã«ã‚ã‚ã›ã¦</div>
<canvas id="canvas" width="80" height="80" style="display:none"></canvas>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});
const result=document.getElementById("result");
const fx=document.getElementById("fx");

const ROI_D=80;              // åˆ¤å®šã‚µã‚¤ã‚º
const NEED_HITS=2;           // æ¿€ã‚¢ãƒï¼ˆ2å›é€£ç¶šï¼‰
const LOCK_TIME=600;         // msï¼ˆçŸ­ã‚ï¼‰

let state="none";
let lockUntil=0;
let hitAngel=0, hitNio=0;
let fxTimer=null;

navigator.mediaDevices.getUserMedia({
  video:{facingMode:"environment"},audio:false
}).then(s=>video.srcObject=s);

/* ===== FX ===== */
function clearFX(){
  fx.innerHTML="";
  if(fxTimer){clearInterval(fxTimer);fxTimer=null;}
}
function startFX(type){
  clearFX();
  const emoji=(type==="angel")?"ğŸ˜ˆ":"âœ¨";
  fxTimer=setInterval(()=>{
    if(fx.children.length>=20) return;
    const p=document.createElement("div");
    p.className="particle";
    p.textContent=emoji;
    p.style.left=(Math.random()*100)+"vw";
    p.style.top="-10vh";
    p.style.animationDuration=(2.5+Math.random()*1.5)+"s"; // é€Ÿã‚
    fx.appendChild(p);
    setTimeout(()=>p.remove(),5000);
  },180); // ç”Ÿæˆã‚‚é€Ÿã‚
}

/* ===== è¡¨ç¤º ===== */
function setState(newState){
  if(newState===state) return;
  state=newState;
  lockUntil=Date.now()+LOCK_TIME;
  hitAngel=0; hitNio=0;

  if(newState==="angel"){
    result.className="ng";
    result.textContent="NG!\nå •å¤©ä½¿ãƒ«ã‚·ãƒ•ã‚¡ãƒ¼";
    startFX("angel");
  }else if(newState==="nio"){
    result.className="ok";
    result.textContent="OK!\nå¤§å¤©ä½¿ãƒŸã‚«ã‚¨ãƒ«";
    startFX("nio");
  }else{
    result.className="";
    result.textContent="å††ã‚’â—ã«ã‚ã‚ã›ã¦";
    clearFX();
  }
}

/* ===== åˆ¤å®š ===== */
function check(){
  if(!video.videoWidth) return;
  if(Date.now()<lockUntil) return;

  const sx=(video.videoWidth-ROI_D)/2;
  const sy=(video.videoHeight-ROI_D)/2;
  ctx.drawImage(video,sx,sy,ROI_D,ROI_D,0,0,ROI_D,ROI_D);
  const d=ctx.getImageData(0,0,ROI_D,ROI_D).data;

  let r=0,g=0,b=0,n=d.length/4;
  for(let i=0;i<d.length;i+=4){
    r+=d[i]; g+=d[i+1]; b+=d[i+2];
  }
  r/=n; g/=n; b/=n;

  const lum=(r+g+b)/3;
  if(lum<20){ setState("none"); return; }

  /* æ¥µç«¯è‰²ãƒ»æ¿€ã‚¢ãƒ */
  const cyanAdv=(g+b)-(2*r);
  const magAdv =(r+b)-(2*g);

  const isAngel =
    (g>100 && b>100 && r<180) ||
    (cyanAdv>80);

  const isNio =
    (r>100 && b>100 && g<180) ||
    (magAdv>80);

  if(isAngel && !isNio){
    hitAngel++; hitNio=0;
    if(hitAngel>=NEED_HITS) setState("angel");
    return;
  }
  if(isNio && !isAngel){
    hitNio++; hitAngel=0;
    if(hitNio>=NEED_HITS) setState("nio");
    return;
  }

  if(isAngel && isNio){
    if(cyanAdv>=magAdv){
      hitAngel++; if(hitAngel>=NEED_HITS) setState("angel");
    }else{
      hitNio++; if(hitNio>=NEED_HITS) setState("nio");
    }
    return;
  }

  hitAngel=hitNio=0;
  setState("none");
}

setInterval(check,150);
</script>

</body>
</html>
