<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ©ãƒ³ãƒ—ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ ãƒ‡ãƒ¢</title>

<style>
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    overflow: hidden;
  }

  video {
    width: 100vw;
    height: 100vh;
    object-fit: cover;
  }

  /* ROIï¼šä¸­å¤®ãƒ»ä¸¸ */
  #roi {
    position: fixed;
    top: 50%;
    left: 50%;
    width: 220px;
    height: 220px;
    transform: translate(-50%, -50%);
    border: 4px solid yellow;
    border-radius: 50%;
    box-sizing: border-box;
    pointer-events: none;
    z-index: 3;
  }

  #result {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 30px;
    font-weight: 900;
    text-align: center;
    line-height: 1.25;
    text-shadow: 0 0 16px rgba(0,0,0,0.9);
    white-space: pre-line;
    padding: 0 16px;
    z-index: 3;
  }

  .ok { color: #00ff66; }
  .ng { color: #ff3333; }

  /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
  #fx {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 2;
    overflow: hidden;
  }

  .particle {
    position: absolute;
    font-size: 22px;
    opacity: 0.85;
    animation: float linear infinite;
  }

  @keyframes float {
    from { transform: translateY(0); }
    to   { transform: translateY(-120vh); }
  }
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<div id="fx"></div>
<div id="roi"></div>
<div id="result">å††ã‚’â—ã«ã‚ã‚ã›ã¦</div>

<canvas id="canvas" width="200" height="200" style="display:none;"></canvas>

<script>
const video  = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx    = canvas.getContext("2d", { willReadFrequently: true });
const result = document.getElementById("result");
const fx     = document.getElementById("fx");

const ROI_D = 200;

// çŠ¶æ…‹ç®¡ç†
let lastLabel = "none";
let holdUntil = 0;
let fxTimer = null;

// ã‚«ãƒ¡ãƒ©èµ·å‹•
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" },
  audio: false
}).then(stream => {
  video.srcObject = stream;
});

// ===== ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç®¡ç† =====
function clearFX() {
  fx.innerHTML = "";
  if (fxTimer) {
    clearInterval(fxTimer);
    fxTimer = null;
  }
}

function startFX(type) {
  clearFX();

  const emoji = (type === "angel") ? "ğŸ˜ˆ" : "âœ¨";
  const maxParticles = 24;

  fxTimer = setInterval(() => {
    if (fx.children.length >= maxParticles) return;

    const p = document.createElement("div");
    p.className = "particle";
    p.textContent = emoji;

    const x = Math.random() * 100;
    const size = (type === "angel")
      ? 18 + Math.random() * 10
      : 16 + Math.random() * 14;

    const duration = 6 + Math.random() * 6;

    p.style.left = x + "vw";
    p.style.bottom = "-10vh";
    p.style.fontSize = size + "px";
    p.style.animationDuration = duration + "s";

    fx.appendChild(p);

    // çµ‚ã‚ã£ãŸã‚‰æ¶ˆã™
    setTimeout(() => {
      if (p.parentNode) p.remove();
    }, duration * 1000);

  }, 350);
}

// è¡¨ç¤ºæ›´æ–°
function setLabel(label, className, text) {
  const now = Date.now();
  if (label !== lastLabel) {
    lastLabel = label;
    holdUntil = now + 900;

    result.className = className;
    result.textContent = text;

    if (label === "angel") startFX("angel");
    else if (label === "nio") startFX("nio");
    else clearFX();
  }
}

// ===== åˆ¤å®š =====
function checkColor() {
  if (video.videoWidth === 0) return;

  const sx = (video.videoWidth  - ROI_D) / 2;
  const sy = (video.videoHeight - ROI_D) / 2;

  ctx.drawImage(video, sx, sy, ROI_D, ROI_D, 0, 0, ROI_D, ROI_D);
  const data = ctx.getImageData(0, 0, ROI_D, ROI_D).data;

  let r = 0, g = 0, b = 0;
  const pixels = data.length / 4;

  for (let i = 0; i < data.length; i += 4) {
    r += data[i];
    g += data[i + 1];
    b += data[i + 2];
  }

  r /= pixels; g /= pixels; b /= pixels;

  const lum = (r + g + b) / 3;
  const now = Date.now();
  if (now < holdUntil) return;

  if (lum < 45) {
    setLabel("none", "", "å††ã‚’â—ã«ã‚ã‚ã›ã¦");
    return;
  }

  // é»„è‰²ï¼ˆå¤©ä½¿ï¼‰æœ€å„ªå…ˆ
  const isYellow =
    r > 180 && g > 180 &&
    Math.abs(r - g) < 18 &&
    b < 95 && lum > 140;

  // èµ¤ï¼ˆé‡‘å‰›åŠ›å£«ï¼‰
  const isRed =
    r > 170 &&
    r > g * 1.4 &&
    r > b * 1.5;

  if (isYellow) {
    setLabel("angel", "ng", "NGï¼\nå®Ÿã¯å •å¤©ä½¿ã€€æ°—ã‚’ã¤ã‘ã¦");
    return;
  }

  if (isRed) {
    setLabel("nio", "ok", "OKï¼\né‡‘å‰›åŠ›å£«ã€€è¦‹ãŸç›®ã¯é¬¼ã§ã‚‚å®ˆã‚Šç¥");
    return;
  }

  setLabel("none", "", "å††ã‚’â—ã«ã‚ã‚ã›ã¦");
}

setInterval(checkColor, 200);
</script>

</body>
</html>
