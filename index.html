<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ©ãƒ³ãƒ—ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ ãƒ‡ãƒ¢</title>

<style>
  body { margin:0; background:#000; color:#fff; font-family:system-ui; overflow:hidden; }
  video { width:100vw; height:100vh; object-fit:cover; }

  /* ROIï¼šä¸­å¤®ãƒ»ä¸¸ï¼ˆå°ï¼‰ */
  #roi{
    position:fixed; top:50%; left:50%;
    width:75px; height:75px; transform:translate(-50%,-50%);
    border:4px solid yellow; border-radius:50%;
    pointer-events:none; z-index:3;
  }

  #result{
    position:fixed; bottom:28px; left:50%; transform:translateX(-50%);
    font-size:30px; font-weight:900; text-align:center; line-height:1.25;
    text-shadow:0 0 16px rgba(0,0,0,.9); white-space:pre-line; z-index:3;
  }
  .ok{ color:#00ff66; }
  .ng{ color:#ff3333; }

  #fx{ position:fixed; inset:0; pointer-events:none; z-index:2; }
  .particle{ position:absolute; font-size:18px; opacity:.85; animation:float linear infinite; }
  @keyframes float{ from{transform:translateY(0)} to{transform:translateY(-120vh)} }
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<div id="fx"></div>
<div id="roi"></div>
<div id="result">å††ã‚’â—ã«ã‚ã‚ã›ã¦</div>
<canvas id="canvas" width="60" height="60" style="display:none"></canvas>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});
const result=document.getElementById("result");
const fx=document.getElementById("fx");

const ROI_D=60;
let lastLabel="none", holdUntil=0, fxTimer=null;

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false})
.then(s=>video.srcObject=s);

// ===== FX =====
function clearFX(){ fx.innerHTML=""; if(fxTimer){clearInterval(fxTimer); fxTimer=null;} }
function startFX(type){
  clearFX();
  const emoji=(type==="angel")?"ğŸ˜ˆ":"âœ¨";
  fxTimer=setInterval(()=>{
    if(fx.children.length>=18) return;
    const p=document.createElement("div");
    p.className="particle"; p.textContent=emoji;
    p.style.left=(Math.random()*100)+"vw";
    p.style.bottom="-10vh";
    p.style.animationDuration=(6+Math.random()*6)+"s";
    fx.appendChild(p);
    setTimeout(()=>p.remove(),12000);
  },350);
}

function setLabel(label,cls,text){
  const now=Date.now();
  if(label!==lastLabel){
    lastLabel=label; holdUntil=now+900;
    result.className=cls; result.textContent=text;
    if(label==="angel") startFX("angel");
    else if(label==="nio") startFX("nio");
    else clearFX();
  }
}

// ===== åˆ¤å®š =====
function checkColor(){
  if(!video.videoWidth) return;

  const sx=(video.videoWidth-ROI_D)/2;
  const sy=(video.videoHeight-ROI_D)/2;
  ctx.drawImage(video,sx,sy,ROI_D,ROI_D,0,0,ROI_D,ROI_D);
  const d=ctx.getImageData(0,0,ROI_D,ROI_D).data;

  let r=0,g=0,b=0,n=d.length/4;
  for(let i=0;i<d.length;i+=4){ r+=d[i]; g+=d[i+1]; b+=d[i+2]; }
  r/=n; g/=n; b/=n;

  const lum=(r+g+b)/3;
  if(Date.now()<holdUntil) return;
  if(lum<40){ setLabel("none","", "å††ã‚’â—ã«ã‚ã‚ã›ã¦"); return; }

  // === é»„è‰²ï¼ˆå¤©ä½¿ï¼‰: èµ¤å„ªä½ã‚’æ˜ç¢ºã«æ’é™¤ ===
  const yellowIndex=(r+g)-2*b; // é»„ã‚‰ã—ã•
  const isYellow =
    g >= r*0.95 && g <= r*1.05 &&   // Rã¨GãŒæ‹®æŠ—ï¼ˆèµ¤ç¦æ­¢ï¼‰
    r > 140 && g > 140 &&            // æ˜ã‚‹ã•
    b < 120 &&                       // é’ã‚’æŠ‘åˆ¶
    yellowIndex > 140 &&             // é»„æŒ‡æ•°
    lum > 120;

  // === èµ¤ï¼ˆé‡‘å‰›åŠ›å£«ï¼‰ ===
  const isRed =
    r > 165 &&
    r > g * 1.35 &&
    r > b * 1.45;

  // å„ªå…ˆé †ä½ï¼šé»„è‰² â†’ èµ¤
  if(isYellow){
    setLabel("angel","ng","NGï¼\nå®Ÿã¯å •å¤©ä½¿ã€€æ°—ã‚’ã¤ã‘ã¦");
    return;
  }
  if(isRed){
    setLabel("nio","ok","OKï¼\né‡‘å‰›åŠ›å£«ã€€è¦‹ãŸç›®ã¯é¬¼ã§ã‚‚å®ˆã‚Šç¥");
    return;
  }
  setLabel("none","", "å††ã‚’â—ã«ã‚ã‚ã›ã¦");
}
setInterval(checkColor,200);
</script>

</body>
</html>
