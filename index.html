<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ©ãƒ³ãƒ—ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ ãƒ‡ãƒ¢</title>

<style>
  body{margin:0;background:#000;color:#fff;font-family:system-ui;overflow:hidden}
  video{width:100vw;height:100vh;object-fit:cover}

  /* ROIï¼šä¸­å¤®ãƒ»ä¸¸ãƒ»å° */
  #roi{
    position:fixed;top:50%;left:50%;
    width:75px;height:75px;
    transform:translate(-50%,-50%);
    border:4px solid #00ffff; /* èª˜å°è‰² */
    border-radius:50%;
    pointer-events:none;z-index:3;
  }

  #result{
    position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
    font-size:30px;font-weight:900;text-align:center;line-height:1.25;
    text-shadow:0 0 16px rgba(0,0,0,.9);white-space:pre-line;z-index:3;
  }
  .ok{color:#00ff66}
  .ng{color:#ff3333}

  /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
  #fx{position:fixed;inset:0;pointer-events:none;z-index:2}
  .particle{position:absolute;font-size:18px;opacity:.85;animation:float linear infinite}
  @keyframes float{from{transform:translateY(0)}to{transform:translateY(-120vh)}}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<div id="fx"></div>
<div id="roi"></div>
<div id="result">å††ã‚’â—ã«ã‚ã‚ã›ã¦</div>
<canvas id="canvas" width="60" height="60" style="display:none"></canvas>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});
const result=document.getElementById("result");
const fx=document.getElementById("fx");

const ROI_D=60;

// å®‰å®šåŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
const NEED_HITS=3;     // é€£ç¶šãƒ’ãƒƒãƒˆæ•°
const LOCK_TIME=1500; // ms

let state="none";      // none | angel | nio
let lockUntil=0;
let hitAngel=0, hitNio=0;
let fxTimer=null;

// ã‚«ãƒ¡ãƒ©èµ·å‹•
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false})
.then(s=>video.srcObject=s);

// ===== ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç®¡ç† =====
function clearFX(){
  fx.innerHTML="";
  if(fxTimer){clearInterval(fxTimer);fxTimer=null;}
}
function startFX(type){
  clearFX();
  const emoji=(type==="angel")?"ğŸ˜ˆ":"âœ¨";
  fxTimer=setInterval(()=>{
    if(fx.children.length>=18) return;
    const p=document.createElement("div");
    p.className="particle";
    p.textContent=emoji;
    p.style.left=(Math.random()*100)+"vw";
    p.style.bottom="-10vh";
    p.style.animationDuration=(6+Math.random()*6)+"s";
    fx.appendChild(p);
    setTimeout(()=>p.remove(),12000);
  },350);
}

// ===== çŠ¶æ…‹ç¢ºå®š =====
function setState(newState){
  state=newState;
  lockUntil=Date.now()+LOCK_TIME;
  hitAngel=0; hitNio=0;

  if(newState==="angel"){
    result.className="ng";
    result.textContent="NGï¼\nå®Ÿã¯å •å¤©ä½¿ã€€æ°—ã‚’ã¤ã‘ã¦";
    startFX("angel");
  }else if(newState==="nio"){
    result.className="ok";
    result.textContent="OKï¼\né‡‘å‰›åŠ›å£«ã€€è¦‹ãŸç›®ã¯é¬¼ã§ã‚‚å®ˆã‚Šç¥";
    startFX("nio");
  }else{
    result.className="";
    result.textContent="å††ã‚’â—ã«ã‚ã‚ã›ã¦";
    clearFX();
  }
}

// ===== åˆ¤å®šãƒ«ãƒ¼ãƒ— =====
function check(){
  if(!video.videoWidth) return;

  // ãƒ­ãƒƒã‚¯ä¸­ã¯ç¶­æŒ
  if(Date.now()<lockUntil) return;

  const sx=(video.videoWidth-ROI_D)/2;
  const sy=(video.videoHeight-ROI_D)/2;
  ctx.drawImage(video,sx,sy,ROI_D,ROI_D,0,0,ROI_D,ROI_D);
  const d=ctx.getImageData(0,0,ROI_D,ROI_D).data;

  let r=0,g=0,b=0,n=d.length/4;
  for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2]}
  r/=n; g/=n; b/=n;

  const lum=(r+g+b)/3;
  if(lum<35){ hitAngel=hitNio=0; setState("none"); return; }

  // === æ¥µç«¯è‰²åˆ¤å®š ===
  // å¤©ä½¿ï¼šã‚·ã‚¢ãƒ³ #00FFFFï¼ˆG,Bé«˜ / Rä½ï¼‰
  const isAngel = (g>200 && b>200 && r<80);

  // é‡‘å‰›åŠ›å£«ï¼šãƒã‚¼ãƒ³ã‚¿ #FF00FFï¼ˆR,Bé«˜ / Gä½ï¼‰
  const isNio   = (r>200 && b>200 && g<80);

  if(isAngel){
    hitAngel++; hitNio=0;
    if(hitAngel>=NEED_HITS) setState("angel");
    return;
  }
  if(isNio){
    hitNio++; hitAngel=0;
    if(hitNio>=NEED_HITS) setState("nio");
    return;
  }

  hitAngel=hitNio=0;
  setState("none");
}

setInterval(check,200);
</script>

</body>
</html>
